# Error Monitoring and Logging Setup Guide\n\n## Overview\nThis guide explains how to set up comprehensive error monitoring and logging for the choma application.\n\n## Components Implemented\n\n### 1. Centralized Error Handling Middleware\n- **Location**: `/middleware/errorHandler.js`\n- **Features**:\n  - Custom error classes for different error types\n  - Winston logger with file rotation\n  - Sentry integration for error tracking\n  - Request ID tracking\n  - Circuit breaker pattern\n  - Error response formatting\n\n### 2. Error Recovery Mechanisms\n- **Location**: `/utils/errorRecovery.js`\n- **Features**:\n  - Retry mechanism with exponential backoff\n  - Circuit breaker for external services\n  - Fallback mechanisms\n  - Timeout handling\n  - Database connection retry\n\n### 3. React Native Error Boundaries\n- **Location**: `/src/components/ErrorBoundary.js`\n- **Features**:\n  - App-wide error catching\n  - Error reporting to backend\n  - Device and app information collection\n  - Local error storage\n  - User-friendly error UI\n\n### 4. Enhanced API Service\n- **Location**: `/src/services/apiWithRecovery.js`\n- **Features**:\n  - Automatic retry on failures\n  - Offline request queueing\n  - Response caching\n  - Circuit breaker protection\n  - Network status monitoring\n\n## Setup Instructions\n\n### 1. Backend Setup\n\n#### Install Dependencies\n```bash\ncd backend\nnpm install winston winston-daily-rotate-file @sentry/node @sentry/tracing\n```\n\n#### Environment Configuration\nAdd to your `.env` file:\n```bash\n# Logging\nLOG_LEVEL=info\n\n# Sentry (optional but recommended)\nSENTRY_DSN=https://your-sentry-dsn@sentry.io/project-id\nSENTRY_ENVIRONMENT=production\n```\n\n#### Log Directory\nThe system automatically creates a `logs/` directory with:\n- `error-YYYY-MM-DD.log` - Error logs only\n- `combined-YYYY-MM-DD.log` - All logs\n- `access-YYYY-MM-DD.log` - HTTP access logs\n\n### 2. Sentry Setup (Recommended)\n\n#### Create Sentry Account\n1. Go to [sentry.io](https://sentry.io)\n2. Create account and project\n3. Get your DSN from project settings\n4. Add DSN to environment variables\n\n#### Sentry Features\n- Automatic error capture\n- Performance monitoring\n- Release tracking\n- User context\n- Environment filtering\n\n### 3. Mobile App Setup\n\n#### Error Boundary Integration\nThe ErrorBoundary is already integrated in `App.js`. It will:\n- Catch JavaScript errors\n- Display user-friendly error screen\n- Report errors to backend\n- Store errors locally for offline sync\n\n#### API Error Recovery\nReplace your current API service with the enhanced version:\n```javascript\nimport { api } from './src/services/apiWithRecovery';\n\n// Use enhanced API methods\nconst mealPlans = await api.mealPlans.getAll();\n```\n\n## Error Types and Handling\n\n### Backend Error Classes\n- `AppError` - Base application error\n- `ValidationError` - Input validation failures\n- `AuthenticationError` - Auth failures\n- `AuthorizationError` - Permission denied\n- `NotFoundError` - Resource not found\n- `ConflictError` - Resource conflicts\n- `RateLimitError` - Rate limit exceeded\n- `DatabaseError` - Database operations\n- `ExternalServiceError` - Third-party service failures\n\n### Error Response Format\n```json\n{\n  \"success\": false,\n  \"status\": \"error\",\n  \"message\": \"User-friendly error message\",\n  \"code\": \"ERROR_CODE\",\n  \"timestamp\": \"2024-01-01T00:00:00.000Z\",\n  \"path\": \"/api/endpoint\",\n  \"method\": \"POST\",\n  \"requestId\": \"abc123def\"\n}\n```\n\n## Monitoring and Alerting\n\n### Log Analysis\nLogs are structured JSON format for easy parsing:\n```json\n{\n  \"level\": \"error\",\n  \"message\": \"Database connection failed\",\n  \"timestamp\": \"2024-01-01T00:00:00.000Z\",\n  \"service\": \"choma-backend\",\n  \"url\": \"/api/orders\",\n  \"method\": \"POST\",\n  \"userId\": \"user123\",\n  \"stack\": \"Error stack trace...\"\n}\n```\n\n### Key Metrics to Monitor\n- Error rate by endpoint\n- Response time distribution\n- Database query performance\n- Circuit breaker state\n- Cache hit rates\n- Offline queue size\n\n### Alerting Rules\nSet up alerts for:\n- Error rate > 5%\n- Response time > 2 seconds\n- Database connection failures\n- Circuit breaker opens\n- Memory usage > 85%\n- Disk space < 10%\n\n## Error Recovery Strategies\n\n### 1. Retry Logic\n- Exponential backoff\n- Maximum retry attempts\n- Jitter to prevent thundering herd\n- Smart retry decisions\n\n### 2. Circuit Breaker\n- Fail fast when service is down\n- Automatic recovery attempts\n- State monitoring\n- Graceful degradation\n\n### 3. Fallback Mechanisms\n- Cached responses\n- Default values\n- Alternative endpoints\n- Offline functionality\n\n### 4. Graceful Degradation\n- Core functionality maintained\n- Non-essential features disabled\n- User notification of limitations\n- Automatic recovery when possible\n\n## Testing Error Handling\n\n### Backend Testing\n```javascript\n// Test error middleware\nconst { AppError } = require('./middleware/errorHandler');\n\napp.get('/test-error', (req, res, next) => {\n  next(new AppError('Test error', 500, 'TEST_ERROR'));\n});\n```\n\n### Frontend Testing\n```javascript\n// Test error boundary\nconst TestError = () => {\n  throw new Error('Test error boundary');\n};\n```\n\n### Load Testing\n- Simulate high error rates\n- Test circuit breaker thresholds\n- Verify retry mechanisms\n- Check memory leaks\n\n## Performance Considerations\n\n### Log Management\n- Daily log rotation\n- Compression of old logs\n- Automatic cleanup\n- Log level filtering\n\n### Memory Usage\n- Limited cache sizes\n- Cleanup of old data\n- Memory monitoring\n- Garbage collection\n\n### Network Efficiency\n- Batch error reporting\n- Compression\n- Background uploads\n- Retry queuing\n\n## Best Practices\n\n### Error Messages\n- User-friendly messages\n- No sensitive information\n- Actionable guidance\n- Consistent formatting\n\n### Logging\n- Structured logging\n- Correlation IDs\n- Context information\n- Appropriate log levels\n\n### Error Reporting\n- Include relevant context\n- Avoid spam\n- Rate limiting\n- User privacy\n\n### Recovery\n- Fast failure detection\n- Quick recovery\n- Minimal user impact\n- Clear status updates\n\n## Troubleshooting\n\n### Common Issues\n1. **High error rates**\n   - Check external services\n   - Verify database connectivity\n   - Review recent deployments\n\n2. **Circuit breaker stuck open**\n   - Check underlying service health\n   - Verify thresholds\n   - Manual reset if needed\n\n3. **Log file growth**\n   - Check log levels\n   - Verify rotation settings\n   - Monitor disk space\n\n4. **Memory leaks**\n   - Check cache sizes\n   - Monitor object references\n   - Profile memory usage\n\n### Debugging Tools\n- Winston log viewer\n- Sentry dashboard\n- Node.js profiler\n- Memory analyzers\n\n## Maintenance\n\n### Regular Tasks\n- Review error logs weekly\n- Update error thresholds\n- Clean old log files\n- Test recovery mechanisms\n- Update dependencies\n\n### Quarterly Reviews\n- Error pattern analysis\n- Performance optimization\n- Threshold adjustments\n- Process improvements\n\n---\n\n**Remember**: Error handling is an ongoing process. Regularly review and improve your error handling strategies based on real-world usage patterns.